<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>True Cost Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .tab-active {
            border-color: #3b82f6;
            color: #3b82f6;
            background-color: #eff6ff;
        }
        .result-card {
            transform-style: preserve-3d;
            transition: transform 0.5s, box-shadow 0.5s;
        }
        .result-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }
        .hidden {
            display: none;
        }
        input[type="range"] {
            -webkit-appearance: none; appearance: none;
            width: 100%; height: 8px; background: #d1d5db;
            border-radius: 5px; outline: none; opacity: 0.7;
            transition: opacity .2s;
        }
        input[type="range"]:hover { opacity: 1; }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 24px; height: 24px; background: #3b82f6;
            cursor: pointer; border-radius: 50%;
        }
        input[type="range"]::-moz-range-thumb {
            width: 24px; height: 24px; background: #3b82f6;
            cursor: pointer; border-radius: 50%;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-900">The True Cost Calculator</h1>
            <p class="mt-2 text-lg text-gray-600">A new perspective on your time, money, and life.</p>
        </header>

        <!-- Tabs -->
        <div class="mb-8 flex justify-center border-b border-gray-200">
            <button id="tab-calculator" class="tab-button tab-active text-sm md:text-base font-medium p-4 border-b-2 border-transparent" onclick="switchTab('calculator')">Purchase Calculator</button>
            <button id="tab-goals" class="tab-button text-sm md:text-base font-medium p-4 border-b-2 border-transparent" onclick="switchTab('goals')">Financial Goals</button>
            <button id="tab-retirement" class="tab-button text-sm md:text-base font-medium p-4 border-b-2 border-transparent" onclick="switchTab('retirement')">Retirement</button>
        </div>

        <main id="app-container">
            <!-- Purchase Calculator Tab -->
            <div id="calculator-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Input Section -->
                    <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-md h-fit">
                        <h2 class="text-2xl font-semibold mb-4 text-gray-800">Your Details</h2>
                        <div class="space-y-4">
                             <div>
                                <label for="age" class="block text-sm font-medium text-gray-700">Your Age</label>
                                <input type="number" id="age" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md" placeholder="e.g., 30">
                            </div>
                            <div>
                                <label for="gender" class="block text-sm font-medium text-gray-700">Gender</label>
                                <select id="gender" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md">
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                </select>
                            </div>
                            <hr>
                            <h2 class="text-xl font-semibold text-gray-800 pt-2">Your Purchase</h2>
                            <div>
                                <label for="itemName" class="block text-sm font-medium text-gray-700">Item Name</label>
                                <input type="text" id="itemName" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md" placeholder="e.g., New Smartphone">
                            </div>
                            <div>
                                <label for="itemCost" class="block text-sm font-medium text-gray-700">Cost (USD)</label>
                                <input type="number" id="itemCost" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md" placeholder="e.g., 999">
                            </div>
                            <div>
                                <label for="preTaxHourlyIncome" class="block text-sm font-medium text-gray-700">Pre-Tax Hourly Income</label>
                                <input type="number" id="preTaxHourlyIncome" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md" placeholder="e.g., 35">
                            </div>
                             <div>
                                <label for="location" class="block text-sm font-medium text-gray-700">Your State</label>
                                <select id="location" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md">
                                    <option value="CA">California</option>
                                    <option value="OR" selected>Oregon</option>
                                    <option value="WA">Washington</option>
                                    <option value="TX">Texas</option>
                                    <option value="FL">Florida</option>
                                    <option value="NY">New York</option>
                                </select>
                            </div>
                            <button id="calculateBtn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-300 transform hover:scale-105">Calculate True Cost</button>
                        </div>
                    </div>

                    <!-- Results Section -->
                    <div id="results-section" class="lg:col-span-2 space-y-6 hidden">
                        <div class="text-center p-4 bg-white rounded-lg shadow">
                             <h2 class="text-3xl font-bold text-gray-900">The True Cost of a <span id="resultItemName" class="text-blue-600"></span></h2>
                             <p class="text-gray-600">Base Cost: <span id="baseCostDisplay" class="font-semibold"></span> + Est. Sales Tax: <span id="taxDisplay" class="font-semibold"></span> = Total: <span id="totalCostWithTax" class="font-semibold"></span></p>
                             <p class="text-gray-600 mt-1">Your estimated net hourly wage: <span id="netIncomeDisplay" class="font-semibold"></span></p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Time Cost -->
                            <div class="result-card bg-white p-6 rounded-xl shadow-md">
                                <div class="flex items-center mb-3"><i data-lucide="clock" class="w-8 h-8 text-blue-500 mr-3"></i><h3 class="text-xl font-semibold text-gray-800">Time Cost</h3></div>
                                <p class="text-gray-600">This purchase will cost you</p>
                                <p class="text-3xl font-bold text-blue-600 my-2"><span id="hoursWorked">0</span> hours</p>
                                <p class="text-gray-600">of your life's work.</p>
                            </div>
                            <!-- Lifetime Perspective -->
                            <div class="result-card bg-white p-6 rounded-xl shadow-md">
                                <div class="flex items-center mb-3"><i data-lucide="user-check" class="w-8 h-8 text-teal-500 mr-3"></i><h3 class="text-xl font-semibold text-gray-800">Lifetime Perspective</h3></div>
                                <p class="text-gray-600">You have approx. <strong id="hoursLeft" class="text-teal-600"></strong> waking hours left in your healthy life.</p>
                                <p class="text-gray-600 mt-2">This purchase consumes <strong id="lifePercentage" class="text-teal-600"></strong> of one of those precious years.</p>
                            </div>
                            <!-- Meaningful Alternatives Chart -->
                            <div class="result-card bg-white p-6 rounded-xl shadow-md md:col-span-2">
                                <div class="flex items-center mb-3"><i data-lucide="gift" class="w-8 h-8 text-cyan-500 mr-3"></i><h3 class="text-xl font-semibold text-gray-800">Meaningful Alternatives</h3></div>
                                <p class="text-gray-600 mb-4">Here's how the cost compares to other essentials and experiences:</p>
                                <canvas id="alternativesChart"></canvas>
                            </div>
                            <!-- Opportunity Cost -->
                            <div class="result-card bg-white p-6 rounded-xl shadow-md md:col-span-2">
                                <div class="flex items-center mb-3"><i data-lucide="trending-up" class="w-8 h-8 text-green-500 mr-3"></i><h3 class="text-xl font-semibold text-gray-800">Future Value Projection</h3></div>
                                <p class="text-gray-600 mb-4">If invested, this money could grow significantly over 20 years:</p>
                                <canvas id="futureValueChart"></canvas>
                                <p class="text-xs text-center mt-2 text-gray-500">Based on simplified avg. annual returns: S&P 500 (8%), BTC (15%), Gold (4%). Not financial advice.</p>
                            </div>
                            <!-- Purchasing Power Erosion -->
                            <div class="result-card bg-white p-6 rounded-xl shadow-md md:col-span-2">
                                <div class="flex items-center mb-3"><i data-lucide="trending-down" class="w-8 h-8 text-red-500 mr-3"></i><h3 class="text-xl font-semibold text-gray-800">Purchasing Power Erosion</h3></div>
                                <p class="text-gray-600 mb-4">If left as cash, the value of this money is projected to decline due to inflation:</p>
                                <canvas id="purchasingPowerChart"></canvas>
                                <p class="text-xs text-center mt-2 text-gray-500">This chart shows the declining purchasing power of your money, assuming a 3% annual inflation rate. Investing helps combat this loss.</p>
                            </div>
                             <!-- Happiness Scale -->
                            <div class="result-card bg-white p-6 rounded-xl shadow-md md:col-span-2">
                                <div class="flex items-center mb-3"><i data-lucide="smile" class="w-8 h-8 text-purple-500 mr-3"></i><h3 class="text-xl font-semibold text-gray-800">Is It Worth It?</h3></div>
                                <label for="happinessScale" class="block text-sm font-medium text-gray-700 mb-2">On a scale of 1-10, how much long-term happiness will this bring you?</label>
                                <input type="range" id="happinessScale" min="1" max="10" value="5" class="w-full">
                                <div class="text-center mt-2"><span id="happinessValue" class="text-2xl font-bold text-purple-600">5</span></div>
                                <p id="happinessVerdict" class="text-center mt-2 text-gray-600 font-medium"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Financial Goals Tab -->
            <div id="goals-content" class="hidden max-w-2xl mx-auto">
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-800">Set Your Financial Goal</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="goalName" class="block text-sm font-medium text-gray-700">Goal Name</label>
                            <input type="text" id="goalName" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md" placeholder="e.g., Down Payment for House">
                        </div>
                        <div>
                            <label for="goalAmount" class="block text-sm font-medium text-gray-700">Goal Amount (USD)</label>
                            <input type="number" id="goalAmount" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md" placeholder="e.g., 40000">
                        </div>
                        <div>
                            <label for="currentSavings" class="block text-sm font-medium text-gray-700">Current Savings for this Goal</label>
                            <input type="number" id="currentSavings" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md" placeholder="e.g., 5000">
                        </div>
                        <button id="setGoalBtn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition">Set Goal & See Progress</button>
                    </div>
                </div>
                <div id="goal-tracker-section" class="mt-8 hidden">
                    <h3 class="text-2xl font-bold text-center">Progress Towards <span id="goalResultName" class="text-blue-600"></span></h3>
                    <div class="bg-white p-6 rounded-lg shadow mt-4">
                         <canvas id="goalDonutChart" class="max-w-xs mx-auto"></canvas>
                         <p class="text-center mt-4 text-gray-600">Skipping the <strong id="goalItemName"></strong> would add <strong id="goalContribution" class="text-green-600"></strong> to your goal!</p>
                    </div>
                </div>
            </div>

            <!-- Retirement Tab -->
            <div id="retirement-content" class="hidden">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Retirement Inputs -->
                    <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-md h-fit">
                        <h2 class="text-2xl font-semibold mb-4 text-gray-800">Retirement Details</h2>
                        <div class="space-y-4">
                            <div>
                                <label for="retireAge" class="block text-sm font-medium text-gray-700">Current Age</label>
                                <input type="number" id="retireAge" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md" placeholder="e.g., 30">
                            </div>
                            <div>
                                <label for="annualIncome" class="block text-sm font-medium text-gray-700">Annual Pre-Tax Income</label>
                                <input type="number" id="annualIncome" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md" placeholder="e.g., 70000">
                            </div>
                            <div>
                                <label for="currentRetireSavings" class="block text-sm font-medium text-gray-700">Current Retirement Savings</label>
                                <input type="number" id="currentRetireSavings" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md" placeholder="e.g., 50000">
                            </div>
                            <div>
                                <label for="savingsRate" class="block text-sm font-medium text-gray-700">Annual Savings Rate (%)</label>
                                <input type="number" id="savingsRate" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md" placeholder="e.g., 15">
                            </div>
                             <div>
                                <label for="annualExpenses" class="block text-sm font-medium text-gray-700">Est. Annual Retirement Expenses</label>
                                <input type="number" id="annualExpenses" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md" placeholder="e.g., 40000">
                            </div>
                            <button id="calculateRetireBtn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition">Calculate Retirement</button>
                        </div>
                    </div>
                    <!-- Retirement Results -->
                    <div id="retirement-results-section" class="lg:col-span-2 space-y-6 hidden">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="result-card bg-white p-6 rounded-xl shadow-md text-center">
                                <h3 class="text-xl font-semibold text-gray-800">Projected Retirement Age</h3>
                                <p id="retirementAgeResult" class="text-6xl font-bold text-blue-600 my-2">0</p>
                            </div>
                             <div class="result-card bg-white p-6 rounded-xl shadow-md text-center">
                                <h3 class="text-xl font-semibold text-gray-800">Retirement Snapshot</h3>
                                <p class="text-gray-600 mt-2">FI Number: <strong id="fiNumberResult" class="text-gray-800"></strong></p>
                                <p class="text-gray-600">4% Withdrawal: <strong id="withdrawalResult" class="text-gray-800"></strong>/yr</p>
                                <p class="text-gray-600">Portfolio lasts for: <strong class="text-gray-800">~30 years</strong></p>
                            </div>
                        </div>
                        <div class="result-card bg-white p-6 rounded-xl shadow-md">
                            <h3 class="text-xl font-semibold text-center mb-4">The Impact of This Purchase</h3>
                            <p class="text-center text-gray-600 mb-4">Investing the <strong id="retireItemName" class="text-green-600"></strong> instead of spending it could buy you more time in retirement.</p>
                            <div id="purchaseImpactResult" class="p-4 rounded-lg bg-green-50 text-center">
                                <!-- Content generated by JS -->
                            </div>
                        </div>
                        <div class="result-card bg-white p-6 rounded-xl shadow-md">
                            <h3 class="text-xl font-semibold text-center mb-4">What Your Extra Retirement Time Means</h3>
                            <div id="retirementMeaning" class="text-center text-gray-700"></div>
                        </div>
                        <div class="result-card bg-white p-6 rounded-xl shadow-md">
                            <h3 class="text-xl font-semibold text-center mb-4">The Value of Time: Work vs. Freedom</h3>
                            <p class="text-center text-gray-600 mb-4">Retiring earlier means more time for what matters.</p>
                            <div id="timeValueTable" class="space-y-4"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- State, Config, and Chart Instances ---
        const stateData = {
            'CA': { name: 'California', salesTax: 0.0725, incomeTaxRate: 0.06, avgRent: 1750, avgUtils: 280, avgGrocery: 250, avgWeekend: 750 },
            'OR': { name: 'Oregon', salesTax: 0.0, incomeTaxRate: 0.08, avgRent: 1450, avgUtils: 210, avgGrocery: 220, avgWeekend: 650 },
            'WA': { name: 'Washington', salesTax: 0.065, incomeTaxRate: 0.0, avgRent: 1600, avgUtils: 230, avgGrocery: 240, avgWeekend: 700 },
            'TX': { name: 'Texas', salesTax: 0.0625, incomeTaxRate: 0.0, avgRent: 1300, avgUtils: 250, avgGrocery: 200, avgWeekend: 600 },
            'FL': { name: 'Florida', salesTax: 0.06, incomeTaxRate: 0.0, avgRent: 1700, avgUtils: 260, avgGrocery: 230, avgWeekend: 800 },
            'NY': { name: 'New York', salesTax: 0.04, incomeTaxRate: 0.055, avgRent: 2500, avgUtils: 200, avgGrocery: 280, avgWeekend: 900 }
        };
        const FICA_RATE = 0.0765;
        const FEDERAL_TAX_RATE = 0.15;
        const LIFE_EXPECTANCY = { male: 73, female: 79 };
        const WAKING_HOURS_PER_YEAR = 16 * 365;
        const AVG_MARKET_RETURN = 0.07; // After inflation

        let currentGoal = { name: '', amount: 0, saved: 0 };
        let lastCalculatedCost = 0;
        let chartInstances = {};

        // --- DOM Elements ---
        const calculateBtn = document.getElementById('calculateBtn');
        const resultsSection = document.getElementById('results-section');
        const setGoalBtn = document.getElementById('setGoalBtn');
        const goalTrackerSection = document.getElementById('goal-tracker-section');
        const calculateRetireBtn = document.getElementById('calculateRetireBtn');
        const retirementResultsSection = document.getElementById('retirement-results-section');

        // --- Utility Functions ---
        const formatCurrency = (v) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(v);
        const formatNumber = (v, d = 2) => Number(v).toLocaleString(undefined, { minimumFractionDigits: d, maximumFractionDigits: d });
        
        // --- Tab Switching ---
        function switchTab(tabName) {
            ['calculator', 'goals', 'retirement'].forEach(name => {
                const content = document.getElementById(`${name}-content`);
                const tab = document.getElementById(`tab-${name}`);
                if (content && tab) {
                    content.classList.add('hidden');
                    tab.classList.remove('tab-active');
                }
            });
            const activeContent = document.getElementById(`${tabName}-content`);
            const activeTab = document.getElementById(`tab-${tabName}`);
            if(activeContent && activeTab) {
                activeContent.classList.remove('hidden');
                activeTab.classList.add('tab-active');
            }
        }

        // --- Core Calculation Logic ---
        function calculatePurchase() {
            const age = parseInt(document.getElementById('age').value) || 0;
            const gender = document.getElementById('gender').value;
            const itemName = document.getElementById('itemName').value || "this item";
            const itemCost = parseFloat(document.getElementById('itemCost').value) || 0;
            const preTaxHourlyIncome = parseFloat(document.getElementById('preTaxHourlyIncome').value) || 0;
            const state = document.getElementById('location').value;

            if (itemCost <= 0 || preTaxHourlyIncome <= 0 || age <= 0) {
                alert("Please enter a valid age, cost, and pre-tax hourly income.");
                return;
            }
            
            document.getElementById('retireAge').value = age;
            document.getElementById('annualIncome').value = preTaxHourlyIncome * 40 * 52;

            const selectedState = stateData[state];
            const totalTaxRate = FEDERAL_TAX_RATE + FICA_RATE + selectedState.incomeTaxRate;
            const netHourlyIncome = preTaxHourlyIncome * (1 - totalTaxRate);
            const salesTaxAmount = itemCost * selectedState.salesTax;
            const totalCost = itemCost + salesTaxAmount;
            lastCalculatedCost = totalCost;
            const hoursWorked = totalCost / netHourlyIncome;

            const yearsLeft = LIFE_EXPECTANCY[gender] - age;
            const hoursLeftInLife = yearsLeft > 0 ? yearsLeft * WAKING_HOURS_PER_YEAR : 0;
            const lifePercentage = hoursLeftInLife > 0 ? (hoursWorked / WAKING_HOURS_PER_YEAR) * 100 : 0;

            resultsSection.classList.remove('hidden');
            document.getElementById('resultItemName').textContent = itemName;
            document.getElementById('baseCostDisplay').textContent = formatCurrency(itemCost);
            document.getElementById('taxDisplay').textContent = formatCurrency(salesTaxAmount);
            document.getElementById('totalCostWithTax').textContent = formatCurrency(totalCost);
            document.getElementById('netIncomeDisplay').textContent = formatCurrency(netHourlyIncome);
            document.getElementById('hoursWorked').textContent = formatNumber(hoursWorked, 1);
            
            document.getElementById('hoursLeft').textContent = formatNumber(hoursLeftInLife, 0);
            document.getElementById('lifePercentage').textContent = `${formatNumber(lifePercentage, 6)}%`;
            
            updateChart('alternativesChart', buildAlternativesChartConfig(totalCost, state));
            updateChart('futureValueChart', buildFutureValueChartConfig(totalCost));
            updateChart('purchasingPowerChart', buildPurchasingPowerChartConfig(totalCost));
            updateGoalTracker();
            document.getElementById('happinessScale').dispatchEvent(new Event('input'));
        }

        // --- Charting Functions ---
        function updateChart(canvasId, config) {
            if (chartInstances[canvasId]) chartInstances[canvasId].destroy();
            const ctx = document.getElementById(canvasId).getContext('2d');
            chartInstances[canvasId] = new Chart(ctx, config);
        }

        function buildAlternativesChartConfig(cost, state) {
            const stateInfo = stateData[state];
            return {
                type: 'bar',
                data: {
                    labels: ['This Item', 'Avg. Monthly Rent', 'Avg. Monthly Utilities', 'Weekly Groceries', 'Weekend Getaway'],
                    datasets: [{
                        label: `Cost Comparison in ${stateInfo.name}`,
                        data: [cost, stateInfo.avgRent, stateInfo.avgUtils, stateInfo.avgGrocery, stateInfo.avgWeekend],
                        backgroundColor: ['#ef4444', '#3b82f6', '#14b8a6', '#f97316', '#8b5cf6'],
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    scales: { x: { beginAtZero: true, ticks: { callback: (value) => formatCurrency(value) } } },
                    plugins: { legend: { display: false } }
                }
            };
        }

        function buildFutureValueChartConfig(initialCost) {
            const years = Array.from({length: 21}, (_, i) => i);
            const createProjection = (rate) => years.map(y => initialCost * Math.pow(1 + rate, y));
            return {
                type: 'line',
                data: {
                    labels: years,
                    datasets: [
                        { label: 'S&P 500 (8%)', data: createProjection(0.08), borderColor: '#22c55e', tension: 0.1, fill: false },
                        { label: 'BTC (15%)', data: createProjection(0.15), borderColor: '#f97316', tension: 0.1, fill: false },
                        { label: 'Gold (4%)', data: createProjection(0.04), borderColor: '#eab308', tension: 0.1, fill: false }
                    ]
                },
                options: {
                    responsive: true,
                    scales: { y: { ticks: { callback: (value) => formatCurrency(value) } }, x: { title: { display: true, text: 'Years' } } },
                    plugins: { legend: { position: 'top' } }
                }
            };
        }
        
        function buildPurchasingPowerChartConfig(initialCost) {
            const years = Array.from({length: 21}, (_, i) => i);
            const ppData = years.map(y => initialCost * Math.pow(1 - 0.03, y));
            return {
                type: 'line',
                data: {
                    labels: years,
                    datasets: [{
                        label: 'Declining Purchasing Power',
                        data: ppData,
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: { y: { ticks: { callback: (value) => formatCurrency(value) } }, x: { title: { display: true, text: 'Years' } } },
                    plugins: { legend: { display: false } }
                }
            };
        }
        
        // --- Goal Logic ---
        function setGoal() {
            const goalName = document.getElementById('goalName').value;
            const goalAmount = parseFloat(document.getElementById('goalAmount').value);
            const currentSavings = parseFloat(document.getElementById('currentSavings').value) || 0;
            if (!goalName || goalAmount <= 0) {
                alert("Please enter a valid goal name and amount.");
                return;
            }
            currentGoal = { name: goalName, amount: goalAmount, saved: currentSavings };
            alert(`Goal Set: ${goalName} for ${formatCurrency(goalAmount)}`);
            updateGoalTracker();
        }

        function updateGoalTracker() {
            if (currentGoal.amount <= 0) return;
            goalTrackerSection.classList.remove('hidden');
            document.getElementById('goalResultName').textContent = currentGoal.name;
            document.getElementById('goalItemName').textContent = document.getElementById('itemName').value || "purchase";
            document.getElementById('goalContribution').textContent = formatCurrency(lastCalculatedCost);
            updateChart('goalDonutChart', buildGoalDonutChartConfig());
        }

        function buildGoalDonutChartConfig() {
            const { amount, saved } = currentGoal;
            const potentialSave = lastCalculatedCost > 0 ? lastCalculatedCost : 0;
            const remaining = amount - saved - potentialSave;
            return {
                type: 'doughnut',
                data: {
                    labels: ['Current Savings', 'This Purchase', 'Remaining'],
                    datasets: [{
                        data: [saved, potentialSave, Math.max(0, remaining)],
                        backgroundColor: ['#3b82f6', '#16a34a', '#e5e7eb'],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'top' }, title: { display: true, text: `Goal: ${formatCurrency(amount)}` } }
                }
            };
        }

        // --- Retirement Logic ---
        function calculateYearsToRetire(startSavings, annualSavings, fiNumber) {
            let currentSavings = startSavings;
            let years = 0;
            while (currentSavings < fiNumber && years < 100) {
                currentSavings = currentSavings * (1 + AVG_MARKET_RETURN) + annualSavings;
                years++;
            }
            return years;
        }

        function handleRetirementCalculation() {
            const age = parseInt(document.getElementById('retireAge').value) || 0;
            const annualIncome = parseFloat(document.getElementById('annualIncome').value) || 0;
            const currentRetireSavings = parseFloat(document.getElementById('currentRetireSavings').value) || 0;
            const savingsRate = parseFloat(document.getElementById('savingsRate').value) / 100 || 0;
            const annualExpenses = parseFloat(document.getElementById('annualExpenses').value) || 0;

            if (age <= 0 || annualIncome <= 0 || savingsRate <= 0 || annualExpenses <= 0) {
                alert("Please fill in all retirement fields with valid numbers.");
                return;
            }

            const fiNumber = annualExpenses * 25;
            
            const scenarios = {
                base: {rate: savingsRate},
                s5: {rate: savingsRate + 0.05},
                s10: {rate: savingsRate + 0.10}
            };

            for (const key in scenarios) {
                const scenario = scenarios[key];
                scenario.annualSavings = annualIncome * scenario.rate;
                scenario.years = calculateYearsToRetire(currentRetireSavings, scenario.annualSavings, fiNumber);
                scenario.age = age + scenario.years;
            }

            // Update UI
            retirementResultsSection.classList.remove('hidden');
            document.getElementById('retirementAgeResult').textContent = scenarios.base.age;
            document.getElementById('fiNumberResult').textContent = formatCurrency(fiNumber);
            document.getElementById('withdrawalResult').textContent = formatCurrency(fiNumber * 0.04);
            document.getElementById('retireItemName').textContent = document.getElementById('itemName').value || 'purchase';
            
            updatePurchaseImpact(scenarios.base, annualExpenses);
            updateTimeValueTable(scenarios);
        }
        
        function updatePurchaseImpact(baseScenario, annualExpenses) {
            const container = document.getElementById('purchaseImpactResult');
            const hourlyRetirementCost = annualExpenses / WAKING_HOURS_PER_YEAR;
            const futureValue = lastCalculatedCost * Math.pow(1 + AVG_MARKET_RETURN, baseScenario.years);
            const hoursBought = futureValue / hourlyRetirementCost;
            const daysBought = hoursBought / 16;
            
            container.innerHTML = `
                <p class="font-bold text-2xl text-green-600">+ ${formatNumber(hoursBought, 0)} hours</p>
                <p class="text-sm text-green-700">(${formatNumber(daysBought, 1)} days of freedom)</p>
                <p class="text-xs text-gray-500 mt-2">
                    Assumes purchase amount is invested at ${AVG_MARKET_RETURN * 100}% annually until your retirement at age ${baseScenario.age}.
                </p>
            `;
            
            updateRetirementMeaning(hoursBought);
        }

        function updateRetirementMeaning(hours) {
            const container = document.getElementById('retirementMeaning');
            let message = '';
            if (hours > 1000) {
                message = `With over <strong class="text-blue-600">${formatNumber(hours,0)} extra hours</strong>, you could take a multi-month international trip, write a novel, or dedicate a significant amount of time to a cause you're passionate about. This isn't just a purchase; it's a life-changing amount of freedom.`;
            } else if (hours > 160) { // More than two weeks
                message = `Those <strong class="text-blue-600">${formatNumber(hours,0)} hours</strong> are enough for a long vacation, to complete an online certification to boost your skills, or to spend an entire month of afternoons with your family, completely stress-free.`;
            } else if (hours > 40) { // More than a work week
                message = `What could you do with an extra <strong class="text-blue-600">${formatNumber(hours,0)} hours</strong> of your life? That's a full week to learn a new hobby, tackle a home project, or simply relax and recharge.`;
            } else {
                message = `Even <strong class="text-blue-600">${formatNumber(hours,0)} hours</strong> is precious. That's several long weekends, dozens of dinners with friends, or countless moments spent on your own terms, not someone else's.`;
            }
            container.innerHTML = message;
        }

        function updateTimeValueTable(scenarios) {
            const container = document.getElementById('timeValueTable');
            container.innerHTML = '';
            const gender = document.getElementById('gender').value;
            const lifeExpectancy = LIFE_EXPECTANCY[gender];
            
            const createRow = (label, scenario) => {
                const yearsWorking = scenario.years;
                const yearsRetired = lifeExpectancy - scenario.age;
                const hoursWorking = yearsWorking * 40 * 52;
                const hoursRetired = yearsRetired * WAKING_HOURS_PER_YEAR;
                const daysWorking = hoursWorking / 16;
                const daysRetired = hoursRetired / 16;

                return `
                    <div class="p-3 rounded-lg ${label === 'Current' ? 'bg-gray-100' : 'bg-blue-50'}">
                        <h4 class="font-bold text-lg ${label === 'Current' ? 'text-gray-800' : 'text-blue-800'}">${label} Path</h4>
                        <div class="flex justify-around items-center mt-2 text-center">
                            <div>
                                <i data-lucide="briefcase" class="w-8 h-8 mx-auto text-red-500"></i>
                                <p class="font-semibold text-red-700">${formatNumber(hoursWorking, 0)} hours</p>
                                <p class="text-xs text-gray-500">(${formatNumber(daysWorking, 0)} days)</p>
                            </div>
                            <div>
                                <i data-lucide="sunset" class="w-8 h-8 mx-auto text-green-500"></i>
                                <p class="font-semibold text-green-700">${formatNumber(hoursRetired, 0)} hours</p>
                                <p class="text-xs text-gray-500">(${formatNumber(daysRetired, 0)} days)</p>
                            </div>
                        </div>
                    </div>
                `;
            };

            container.innerHTML += createRow('Current', scenarios.base);
            container.innerHTML += createRow('+5%', scenarios.s5);
            container.innerHTML += createRow('+10%', scenarios.s10);
            lucide.createIcons();
        }

        // --- Event Listeners ---
        calculateBtn.addEventListener('click', calculatePurchase);
        setGoalBtn.addEventListener('click', setGoal);
        calculateRetireBtn.addEventListener('click', handleRetirementCalculation);
        document.getElementById('happinessScale').addEventListener('input', (e) => {
            const value = e.target.value;
            document.getElementById('happinessValue').textContent = value;
            const hours = parseFloat(document.getElementById('hoursWorked').textContent) || 0;
            if (hours === 0) {
                document.getElementById('happinessVerdict').textContent = "Calculate a cost first!";
                return;
            }
            const ratio = value / (hours / 4);
            const verdictEl = document.getElementById('happinessVerdict');
            if (ratio > 2) {
                verdictEl.textContent = "Great value for the happiness it brings!";
                verdictEl.className = "text-center mt-2 font-medium text-green-600";
            } else if (ratio > 1) {
                verdictEl.textContent = "A reasonable trade-off.";
                verdictEl.className = "text-center mt-2 font-medium text-yellow-600";
            } else {
                verdictEl.textContent = "The time cost seems high for the happiness gained.";
                verdictEl.className = "text-center mt-2 font-medium text-red-600";
            }
        });

        // --- Initial Load ---
        window.onload = () => {
            lucide.createIcons();
        };
    </script>
</body>
</html>
