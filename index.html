<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>True Cost Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .tab-active {
            border-color: #4f46e5;
            color: #4f46e5;
            background-color: #eef2ff;
        }
        .result-card {
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .result-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }
        .hidden {
            display: none;
        }
        input[type="range"] {
            -webkit-appearance: none; appearance: none;
            width: 100%; height: 8px; background: #e5e7eb;
            border-radius: 5px; outline: none; opacity: 0.8;
            transition: opacity .2s;
        }
        input[type="range"]:hover { opacity: 1; }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 24px; height: 24px; background: #4f46e5;
            cursor: pointer; border-radius: 50%;
        }
        input[type="range"]::-moz-range-thumb {
            width: 24px; height: 24px; background: #4f46e5;
            cursor: pointer; border-radius: 50%;
        }
        .quiz-option {
            transition: background-color 0.2s, border-color 0.2s, transform 0.2s;
        }
        .quiz-option:hover {
            transform: scale(1.02);
        }
        .gradient-bg {
            background: linear-gradient(135deg, #f5f3ff 0%, #eef2ff 100%);
        }
    </style>
</head>
<body class="gradient-bg text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-extrabold text-gray-900 tracking-tight">The True Cost Calculator</h1>
            <p class="mt-2 text-lg text-gray-600">A new perspective on your time, money, and life.</p>
        </header>

        <!-- Tabs -->
        <div class="mb-8 flex justify-center border-b border-gray-200">
            <button data-tab="calculator" class="tab-button tab-active text-sm md:text-base font-medium p-4 border-b-2 border-transparent">Purchase Calculator</button>
            <button data-tab="motive" class="tab-button text-sm md:text-base font-medium p-4 border-b-2 border-transparent">My Money Motive</button>
            <button data-tab="goals" class="tab-button text-sm md:text-base font-medium p-4 border-b-2 border-transparent">Financial Goals</button>
            <button data-tab="retirement" class="tab-button text-sm md:text-base font-medium p-4 border-b-2 border-transparent">Retirement</button>
        </div>

        <main id="app-container">
            <!-- Purchase Calculator Tab -->
            <div id="calculator-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Input Section -->
                    <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg h-fit space-y-4">
                        <div>
                            <h2 class="text-2xl font-bold mb-4 text-gray-800">Your Details</h2>
                            <div class="space-y-4">
                                <div>
                                    <label for="age" class="block text-sm font-medium text-gray-700">Your Age</label>
                                    <input type="number" id="age" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md" placeholder="e.g., 30">
                                </div>
                                <div>
                                    <label for="gender" class="block text-sm font-medium text-gray-700">Gender</label>
                                    <select id="gender" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md">
                                        <option value="male">Male</option>
                                        <option value="female">Female</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <hr>
                        <div>
                            <h2 class="text-xl font-bold text-gray-800 pt-2">Your Purchase</h2>
                             <div class="space-y-4 mt-4">
                                <div>
                                    <label for="itemName" class="block text-sm font-medium text-gray-700">Item Name</label>
                                    <input type="text" id="itemName" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md" placeholder="e.g., New Smartphone">
                                </div>
                                <div>
                                    <label for="itemCost" class="block text-sm font-medium text-gray-700">Cost (USD)</label>
                                    <input type="number" id="itemCost" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md" placeholder="e.g., 999">
                                </div>
                                <div>
                                    <label for="preTaxHourlyIncome" class="block text-sm font-medium text-gray-700">Pre-Tax Hourly Income</label>
                                    <input type="number" id="preTaxHourlyIncome" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md" placeholder="e.g., 35">
                                </div>
                                <div>
                                    <label for="paycheckFrequency" class="block text-sm font-medium text-gray-700">Paycheck Frequency</label>
                                    <select id="paycheckFrequency" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md">
                                        <option value="weekly">Weekly</option>
                                        <option value="biweekly" selected>Bi-Weekly</option>
                                        <option value="monthly">Monthly</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="location" class="block text-sm font-medium text-gray-700">Your State</label>
                                    <select id="location" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md">
                                        <option value="CA">California</option>
                                        <option value="OR" selected>Oregon</option>
                                        <option value="WA">Washington</option>
                                        <option value="TX">Texas</option>
                                        <option value="FL">Florida</option>
                                        <option value="NY">New York</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                         <hr>
                        <div>
                            <h2 class="text-xl font-bold text-gray-800 pt-2">Financial Snapshot (Optional)</h2>
                            <div class="space-y-4 mt-4">
                                <div>
                                    <label for="currentSavings" class="block text-sm font-medium text-gray-700">Emergency Savings</label>
                                    <input type="number" id="currentSavings" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md" placeholder="e.g., 10000">
                                </div>
                                <div>
                                    <label for="monthlyExpenses" class="block text-sm font-medium text-gray-700">Monthly Expenses</label>
                                    <input type="number" id="monthlyExpenses" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md" placeholder="e.g., 3000">
                                </div>
                            </div>
                        </div>
                        <button id="calculateBtn" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition duration-300 transform hover:scale-105">Calculate True Cost</button>
                    </div>

                    <!-- Results Section -->
                    <div id="results-section" class="lg:col-span-2 space-y-6 hidden">
                        <div class="text-center p-4 bg-white rounded-lg shadow-md">
                             <h2 class="text-3xl font-bold text-gray-900">The True Cost of a <span id="resultItemName" class="text-indigo-600"></span></h2>
                             <p class="text-gray-600">Total Cost: <span id="totalCostWithTax" class="font-semibold"></span></p>
                             <p class="text-gray-600 mt-1">Your estimated net hourly wage: <span id="netIncomeDisplay" class="font-semibold"></span></p>
                        </div>
                        <div id="calculator-fact" class="result-card p-4 rounded-xl shadow-md text-center bg-indigo-50 border border-indigo-200"></div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Time Cost -->
                            <div class="result-card bg-white p-6 rounded-xl shadow-md">
                                <div class="flex items-center mb-3"><i data-lucide="clock" class="w-8 h-8 text-indigo-500 mr-3"></i><h3 class="text-xl font-bold text-gray-800">Time Cost</h3></div>
                                <p class="text-gray-600">This purchase will cost you</p>
                                <p class="text-3xl font-bold text-indigo-600 my-2"><span id="hoursWorked">0</span> hours</p>
                                <p class="text-gray-600">(<span id="daysWorked">0</span> waking days)</p>
                            </div>
                            <!-- Paycheck Power -->
                            <div class="result-card bg-white p-6 rounded-xl shadow-md">
                                <div class="flex items-center mb-3"><i data-lucide="receipt" class="w-8 h-8 text-orange-500 mr-3"></i><h3 class="text-xl font-bold text-gray-800">Paycheck Power</h3></div>
                                <p class="text-gray-600">This purchase is equal to</p>
                                <p class="text-3xl font-bold text-orange-600 my-2"><span id="paycheckPercentage">0</span>%</p>
                                <p class="text-gray-600">of one net paycheck.</p>
                            </div>
                             <!-- Freedom Fund -->
                            <div id="freedom-fund-card" class="result-card bg-white p-6 rounded-xl shadow-md hidden">
                                <div class="flex items-center mb-3"><i data-lucide="shield-half" class="w-8 h-8 text-sky-500 mr-3"></i><h3 class="text-xl font-bold text-gray-800">Freedom Fund</h3></div>
                                <p class="text-gray-600">Your current runway is <strong id="runwayMonths" class="text-sky-600"></strong> months. Saving this adds</p>
                                <p class="text-3xl font-bold text-sky-600 my-2">+<span id="runwayAdded">0</span> days</p>
                                <p class="text-gray-600">to your financial safety net.</p>
                            </div>
                            <!-- Lifetime Perspective -->
                            <div class="result-card bg-white p-6 rounded-xl shadow-md md:col-span-2">
                                <div class="flex items-center mb-3"><i data-lucide="user-check" class="w-8 h-8 text-teal-500 mr-3"></i><h3 class="text-xl font-bold text-gray-800">Lifetime Perspective</h3></div>
                                <p class="text-gray-600">You have approx. <strong id="hoursLeft" class="text-teal-600"></strong> waking hours left in your healthy life.</p>
                                <p class="text-gray-600 mt-2">This purchase consumes <strong id="lifePercentage" class="text-teal-600"></strong> of one of those precious years.</p>
                            </div>
                            <!-- Opportunity Cost -->
                            <div class="result-card bg-white p-6 rounded-xl shadow-md md:col-span-2">
                                <div class="flex items-center mb-3"><i data-lucide="trending-up" class="w-8 h-8 text-green-500 mr-3"></i><h3 class="text-xl font-bold text-gray-800">Future Value Projection</h3></div>
                                <p class="text-gray-600 mb-4">If invested, this money could grow significantly over 20 years:</p>
                                <canvas id="futureValueChart"></canvas>
                                <p class="text-xs text-center mt-2 text-gray-500">Based on updated long-term avg. annual returns: S&P 500 (10%), BTC (15% speculative), Gold (5%). Not financial advice.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Money Motive Tab -->
            <div id="motive-content" class="hidden max-w-2xl mx-auto">
                <div id="quiz-container" class="bg-white p-8 rounded-xl shadow-lg">
                    <h2 class="text-3xl font-bold text-center mb-2">What's Your Money Motive?</h2>
                    <p class="text-center text-gray-600 mb-6">Discover the unconscious beliefs that drive your financial decisions.</p>
                    <div id="quiz-progress-bar" class="w-full bg-gray-200 rounded-full h-2.5 mb-6">
                        <div id="quiz-progress" class="bg-indigo-600 h-2.5 rounded-full" style="width: 0%"></div>
                    </div>
                    <h3 id="quizQuestion" class="text-xl font-semibold text-center mb-6 h-12"></h3>
                    <div id="quizOptions" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Options will be populated by JS -->
                    </div>
                </div>
                <div id="motive-result-container" class="hidden bg-white p-8 rounded-xl shadow-lg text-center">
                    <div id="archetypeIcon" class="mx-auto mb-4"></div>
                    <h2 id="archetypeTitle" class="text-3xl font-bold mb-2"></h2>
                    <div class="text-left space-y-4 mt-6">
                        <div>
                            <h4 class="font-bold text-lg text-gray-800">Core Motivation:</h4>
                            <p id="archetypeDescription" class="text-gray-600"></p>
                        </div>
                        <div>
                            <h4 class="font-bold text-lg text-gray-800">Potential Strengths:</h4>
                            <p id="archetypeStrengths" class="text-gray-600"></p>
                        </div>
                        <div>
                            <h4 class="font-bold text-lg text-gray-800">Potential Blind Spots:</h4>
                            <p id="archetypeBlinds" class="text-gray-600"></p>
                        </div>
                         <div>
                            <h4 class="font-bold text-lg text-gray-800">Mantra for Growth:</h4>
                            <p id="archetypeMantra" class="text-indigo-600 italic font-semibold"></p>
                        </div>
                    </div>
                    <button id="retakeQuizBtn" class="mt-8 bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition">Retake Quiz</button>
                </div>
            </div>
            
            <!-- Financial Goals Tab -->
            <div id="goals-content" class="hidden max-w-2xl mx-auto space-y-6">
                <div id="goals-fact" class="result-card p-4 rounded-xl shadow-md text-center bg-indigo-50 border border-indigo-200 hidden"></div>
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800">Set Your Financial Goal</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="goalName" class="block text-sm font-medium text-gray-700">Goal Name</label>
                            <input type="text" id="goalName" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md" placeholder="e.g., Down Payment for House">
                        </div>
                        <div>
                            <label for="goalAmount" class="block text-sm font-medium text-gray-700">Goal Amount (USD)</label>
                            <input type="number" id="goalAmount" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md" placeholder="e.g., 40000">
                        </div>
                        <div>
                            <label for="currentGoalSavings" class="block text-sm font-medium text-gray-700">Current Savings for this Goal</label>
                            <input type="number" id="currentGoalSavings" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md" placeholder="e.g., 5000">
                        </div>
                        <button id="setGoalBtn" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition">Set Goal & See Progress</button>
                    </div>
                </div>
                <div id="goal-tracker-section" class="mt-8 hidden">
                    <h3 class="text-2xl font-bold text-center">Progress Towards <span id="goalResultName" class="text-indigo-600"></span></h3>
                    <div class="bg-white p-6 rounded-lg shadow-lg mt-4">
                         <canvas id="goalDonutChart" class="max-w-xs mx-auto"></canvas>
                         <p class="text-center mt-4 text-gray-600">Skipping the <strong id="goalItemName"></strong> would add <strong id="goalContribution" class="text-green-600"></strong> to your goal!</p>
                    </div>
                </div>
            </div>

            <!-- Retirement Tab -->
            <div id="retirement-content" class="hidden">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Retirement Inputs -->
                    <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg h-fit">
                        <h2 class="text-2xl font-bold mb-4 text-gray-800">Retirement Details</h2>
                        <div class="space-y-4">
                            <div>
                                <label for="retireAge" class="block text-sm font-medium text-gray-700">Current Age</label>
                                <input type="number" id="retireAge" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md" placeholder="e.g., 30">
                            </div>
                            <div>
                                <label for="annualIncome" class="block text-sm font-medium text-gray-700">Annual Pre-Tax Income</label>
                                <input type="number" id="annualIncome" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md" placeholder="e.g., 70000">
                            </div>
                            <div>
                                <label for="currentRetireSavings" class="block text-sm font-medium text-gray-700">Current Retirement Savings</label>
                                <input type="number" id="currentRetireSavings" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md" placeholder="e.g., 50000">
                            </div>
                            <div>
                                <label for="savingsRate" class="block text-sm font-medium text-gray-700">Annual Savings Rate (%)</label>
                                <input type="number" id="savingsRate" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md" placeholder="e.g., 15">
                            </div>
                             <div>
                                <label for="annualExpenses" class="block text-sm font-medium text-gray-700">Est. Annual Retirement Expenses</label>
                                <input type="number" id="annualExpenses" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md" placeholder="e.g., 40000">
                            </div>
                             <div>
                                <label for="retirementDream" class="block text-sm font-medium text-gray-700">My Retirement Dream Is...</label>
                                <input type="text" id="retirementDream" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md" placeholder="e.g., Traveling the world">
                            </div>
                            <button id="calculateRetireBtn" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition">Calculate Retirement</button>
                        </div>
                    </div>
                    <!-- Retirement Results -->
                    <div id="retirement-results-section" class="lg:col-span-2 space-y-6 hidden">
                        <div id="retirement-fact" class="result-card p-4 rounded-xl shadow-md text-center bg-indigo-50 border border-indigo-200"></div>
                        <div class="result-card bg-white p-6 rounded-xl shadow-md text-center">
                            <h3 class="text-xl font-bold text-gray-800">Your Retirement Goal</h3>
                            <p class="text-2xl text-indigo-600 my-2">"<span id="dreamDisplay"></span>"</p>
                            <p class="text-gray-600">You can achieve this at age <strong id="retirementAgeResult" class="text-indigo-600 text-3xl">0</strong></p>
                        </div>
                         <div class="result-card bg-white p-6 rounded-xl shadow-md text-center">
                            <h3 class="text-xl font-bold text-gray-800">Retirement Snapshot</h3>
                            <p class="text-gray-600 mt-2">FI Number: <strong id="fiNumberResult" class="text-gray-800"></strong></p>
                            <p class="text-gray-600">4% Withdrawal: <strong id="withdrawalResult" class="text-gray-800"></strong>/yr</p>
                            <p class="text-xs text-gray-500 mt-1">Your portfolio is designed to last for a <strong class="font-semibold">30-year retirement</strong>.</p>
                        </div>
                        <div class="result-card bg-white p-6 rounded-xl shadow-md">
                            <h3 class="text-xl font-bold text-center mb-4">The Impact of This Purchase</h3>
                            <p class="text-center text-gray-600 mb-4">Investing the <strong id="retireItemName" class="text-green-600"></strong> instead of spending it could buy you more time in retirement.</p>
                            <div id="purchaseImpactResult" class="p-4 rounded-lg bg-green-50 text-center">
                                <!-- Content generated by JS -->
                            </div>
                        </div>
                        <div class="result-card bg-white p-6 rounded-xl shadow-md">
                            <h3 class="text-xl font-bold text-center mb-4">What Your Extra Retirement Time Means</h3>
                            <div id="retirementMeaning" class="text-center text-gray-700"></div>
                        </div>
                        <div class="result-card bg-white p-6 rounded-xl shadow-md">
                            <h3 class="text-xl font-bold text-center mb-4">Your Life's Timeline</h3>
                            <p class="text-center text-gray-600 mb-4">Based on your current path, here is the breakdown of your life's waking hours.</p>
                            <div id="timeValueTable" class="space-y-4"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- App Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
        });

        // --- State, Config, and Chart Instances ---
        const stateData = {
            'CA': { name: 'California', salesTax: 0.0725, incomeTaxRate: 0.06 },
            'OR': { name: 'Oregon', salesTax: 0.0, incomeTaxRate: 0.08 },
            'WA': { name: 'Washington', salesTax: 0.065, incomeTaxRate: 0.0 },
            'TX': { name: 'Texas', salesTax: 0.0625, incomeTaxRate: 0.0 },
            'FL': { name: 'Florida', salesTax: 0.06, incomeTaxRate: 0.0 },
            'NY': { name: 'New York', salesTax: 0.04, incomeTaxRate: 0.055 }
        };
        const FICA_RATE = 0.0765;
        const FEDERAL_TAX_RATE = 0.15;
        const LIFE_EXPECTANCY = { male: 76, female: 81 }; 
        const WAKING_HOURS_PER_YEAR = 16 * 365;
        const AVG_MARKET_RETURN = 0.07; 

        let currentGoal = { name: '', amount: 0, saved: 0 };
        let lastCalculatedCost = 0;
        let chartInstances = {};
        let userMotive = null;
        
        // --- Utility Functions ---
        const formatCurrency = (v) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(v);
        const formatNumber = (v, d = 2) => Number(v).toLocaleString(undefined, { minimumFractionDigits: d, maximumFractionDigits: d });
        
        // --- Tab Switching ---
        function switchTab(tabName) {
            ['calculator', 'motive', 'goals', 'retirement'].forEach(name => {
                const content = document.getElementById(`${name}-content`);
                const tab = document.querySelector(`[data-tab="${name}"]`);
                if (content && tab) {
                    content.classList.add('hidden');
                    tab.classList.remove('tab-active');
                }
            });
            const activeContent = document.getElementById(`${tabName}-content`);
            const activeTab = document.querySelector(`[data-tab="${tabName}"]`);
            if(activeContent && activeTab) {
                activeContent.classList.remove('hidden');
                activeTab.classList.add('tab-active');
            }
        }

        // --- Core Calculation Logic ---
        function calculatePurchase(elements) {
            const age = parseInt(elements.age.value) || 0;
            const gender = elements.gender.value;
            const itemName = elements.itemName.value || "this item";
            const itemCost = parseFloat(elements.itemCost.value) || 0;
            const preTaxHourlyIncome = parseFloat(elements.preTaxHourlyIncome.value) || 0;
            
            if (itemCost <= 0 || preTaxHourlyIncome <= 0 || age <= 0) {
                alert("Please enter a valid age, cost, and pre-tax hourly income.");
                return;
            }
            
            elements.retireAge.value = age;
            elements.annualIncome.value = preTaxHourlyIncome * 40 * 52;

            const selectedState = stateData[elements.location.value];
            const totalTaxRate = FEDERAL_TAX_RATE + FICA_RATE + selectedState.incomeTaxRate;
            const netHourlyIncome = preTaxHourlyIncome * (1 - totalTaxRate);
            const salesTaxAmount = itemCost * selectedState.salesTax;
            const totalCost = itemCost + salesTaxAmount;
            lastCalculatedCost = totalCost;
            const hoursWorked = totalCost / netHourlyIncome;

            const yearsLeft = LIFE_EXPECTANCY[gender] - age;
            const hoursLeftInLife = yearsLeft > 0 ? yearsLeft * WAKING_HOURS_PER_YEAR : 0;
            const lifePercentage = hoursLeftInLife > 0 ? (hoursWorked / WAKING_HOURS_PER_YEAR) * 100 : 0;

            elements.resultsSection.classList.remove('hidden');
            elements.resultItemName.textContent = itemName;
            elements.totalCostWithTax.textContent = formatCurrency(totalCost);
            elements.netIncomeDisplay.textContent = formatCurrency(netHourlyIncome);
            elements.hoursWorked.textContent = formatNumber(hoursWorked, 1);
            elements.daysWorked.textContent = formatNumber(hoursWorked / 16, 1);
            elements.hoursLeft.textContent = formatNumber(hoursLeftInLife, 0);
            elements.lifePercentage.textContent = `${formatNumber(lifePercentage, 6)}%`;
            
            updateChart('futureValueChart', buildFutureValueChartConfig(totalCost));
            updateGoalTracker(elements);
            displayDynamicFact('calculator', elements);
            
            calculatePaycheckPower(totalCost, preTaxHourlyIncome, totalTaxRate, elements);
            calculateFreedomFund(totalCost, elements);
        }

        // --- New Metric Functions ---
        function calculatePaycheckPower(cost, hourly, taxRate, elements) {
            const freq = elements.paycheckFrequency.value;
            const hoursPerPaycheck = { weekly: 40, biweekly: 80, monthly: 173.33 };
            const netPaycheck = (hourly * hoursPerPaycheck[freq]) * (1 - taxRate);
            if (netPaycheck > 0) {
                const percentage = (cost / netPaycheck) * 100;
                elements.paycheckPercentage.textContent = formatNumber(percentage, 1);
            }
        }

        function calculateFreedomFund(cost, elements) {
            const savings = parseFloat(elements.currentSavings.value) || 0;
            const expenses = parseFloat(elements.monthlyExpenses.value) || 0;
            const card = document.getElementById('freedom-fund-card');
            if (savings > 0 && expenses > 0) {
                const runwayMonths = savings / expenses;
                const daysAdded = (cost / expenses) * 30;
                document.getElementById('runwayMonths').textContent = formatNumber(runwayMonths, 1);
                document.getElementById('runwayAdded').textContent = formatNumber(daysAdded, 1);
                card.classList.remove('hidden');
            } else {
                card.classList.add('hidden');
            }
        }

        // --- Charting Functions ---
        function updateChart(canvasId, config) {
            if (chartInstances[canvasId]) chartInstances[canvasId].destroy();
            const ctx = document.getElementById(canvasId).getContext('2d');
            chartInstances[canvasId] = new Chart(ctx, config);
        }

        function buildFutureValueChartConfig(initialCost) {
            const years = Array.from({length: 21}, (_, i) => i);
            const createProjection = (rate) => years.map(y => initialCost * Math.pow(1 + rate, y));
            return {
                type: 'line',
                data: {
                    labels: years,
                    datasets: [
                        { label: 'S&P 500 (10%)', data: createProjection(0.10), borderColor: '#22c55e', tension: 0.1, fill: false },
                        { label: 'BTC (15%)', data: createProjection(0.15), borderColor: '#f97316', tension: 0.1, fill: false },
                        { label: 'Gold (5%)', data: createProjection(0.05), borderColor: '#eab308', tension: 0.1, fill: false }
                    ]
                },
                options: {
                    responsive: true,
                    scales: { y: { ticks: { callback: (value) => formatCurrency(value) } }, x: { title: { display: true, text: 'Years' } } },
                    plugins: { legend: { position: 'top' } }
                }
            };
        }
        
        // --- Goal Logic ---
        function setGoal(elements) {
            const goalName = elements.goalName.value;
            const goalAmount = parseFloat(elements.goalAmount.value);
            const currentSavings = parseFloat(elements.currentGoalSavings.value) || 0;
            if (!goalName || goalAmount <= 0) {
                alert("Please enter a valid goal name and amount.");
                return;
            }
            currentGoal = { name: goalName, amount: goalAmount, saved: currentSavings };
            alert(`Goal Set: ${goalName} for ${formatCurrency(goalAmount)}`);
            updateGoalTracker(elements);
            displayDynamicFact('goals', elements);
        }

        function updateGoalTracker(elements) {
            if (currentGoal.amount <= 0) return;
            elements.goalTrackerSection.classList.remove('hidden');
            elements.goalResultName.textContent = currentGoal.name;
            elements.goalItemName.textContent = elements.itemName.value || "purchase";
            elements.goalContribution.textContent = formatCurrency(lastCalculatedCost);
            updateChart('goalDonutChart', buildGoalDonutChartConfig());
        }

        function buildGoalDonutChartConfig() {
            const { amount, saved } = currentGoal;
            const potentialSave = lastCalculatedCost > 0 ? lastCalculatedCost : 0;
            const remaining = amount - saved - potentialSave;
            return {
                type: 'doughnut',
                data: {
                    labels: ['Current Savings', 'This Purchase', 'Remaining'],
                    datasets: [{
                        data: [saved, potentialSave, Math.max(0, remaining)],
                        backgroundColor: ['#4f46e5', '#16a34a', '#e5e7eb'],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'top' }, title: { display: true, text: `Goal: ${formatCurrency(amount)}` } }
                }
            };
        }

        // --- Retirement Logic ---
        function calculateYearsToRetire(startSavings, annualSavings, fiNumber) {
            let currentSavings = startSavings;
            let years = 0;
            while (currentSavings < fiNumber && years < 100) {
                currentSavings = currentSavings * (1 + AVG_MARKET_RETURN) + annualSavings;
                years++;
            }
            return years;
        }

        function handleRetirementCalculation(elements) {
            const age = parseInt(elements.retireAge.value) || 0;
            const annualIncome = parseFloat(elements.annualIncome.value) || 0;
            const currentRetireSavings = parseFloat(elements.currentRetireSavings.value) || 0;
            const savingsRate = parseFloat(elements.savingsRate.value) / 100 || 0;
            const annualExpenses = parseFloat(elements.annualExpenses.value) || 0;
            const retirementDream = elements.retirementDream.value || "achieving your dream";

            if (age <= 0 || annualIncome <= 0 || savingsRate <= 0 || annualExpenses <= 0) {
                alert("Please fill in all retirement fields with valid numbers.");
                return;
            }

            const fiNumber = annualExpenses * 25;
            const annualSavings = annualIncome * savingsRate;
            const yearsToRetire = calculateYearsToRetire(currentRetireSavings, annualSavings, fiNumber);
            const retirementAge = age + yearsToRetire;

            elements.retirementResultsSection.classList.remove('hidden');
            elements.dreamDisplay.textContent = retirementDream;
            elements.retirementAgeResult.textContent = retirementAge;
            elements.fiNumberResult.textContent = formatCurrency(fiNumber);
            elements.withdrawalResult.textContent = formatCurrency(fiNumber * 0.04);
            elements.retireItemName.textContent = elements.itemName.value || 'purchase';
            
            const baseScenario = { years: yearsToRetire, age: retirementAge };
            updatePurchaseImpact(baseScenario, annualExpenses, elements);
            updateTimeValueTable(baseScenario, elements);
            displayDynamicFact('retirement', elements);
        }
        
        function updatePurchaseImpact(baseScenario, annualExpenses, elements) {
            const hourlyRetirementCost = annualExpenses / WAKING_HOURS_PER_YEAR;
            const futureValue = lastCalculatedCost * Math.pow(1 + AVG_MARKET_RETURN, baseScenario.years);
            const hoursBought = futureValue / hourlyRetirementCost;
            const daysBought = hoursBought / 16;
            
            elements.purchaseImpactResult.innerHTML = `
                <p class="font-bold text-2xl text-green-600">+ ${formatNumber(hoursBought, 0)} hours</p>
                <p class="text-sm text-green-700">(${formatNumber(daysBought, 1)} days of freedom)</p>
                <p class="text-xs text-gray-500 mt-2">
                    Assumes purchase amount is invested at ${AVG_MARKET_RETURN * 100}% annually until your retirement at age ${baseScenario.age}.
                </p>
            `;
            
            updateRetirementMeaning(hoursBought, elements);
        }

        function updateRetirementMeaning(hours, elements) {
            let message = '';
            if (hours > 1000) {
                message = `With over <strong class="text-indigo-600">${formatNumber(hours,0)} extra hours</strong>, you could take a multi-month international trip, write a novel, or dedicate a significant amount of time to a cause you're passionate about. This isn't just a purchase; it's a life-changing amount of freedom.`;
            } else if (hours > 160) {
                message = `Those <strong class="text-indigo-600">${formatNumber(hours,0)} hours</strong> are enough for a long vacation, to complete an online certification to boost your skills, or to spend an entire month of afternoons with your family, completely stress-free.`;
            } else if (hours > 40) {
                message = `What could you do with an extra <strong class="text-indigo-600">${formatNumber(hours,0)} hours</strong> of your life? That's a full week to learn a new hobby, tackle a home project, or simply relax and recharge.`;
            } else {
                message = `Even <strong class="text-indigo-600">${formatNumber(hours,0)} hours</strong> is precious. That's several long weekends, dozens of dinners with friends, or countless moments spent on your own terms, not someone else's.`;
            }
            elements.retirementMeaning.innerHTML = message;
        }

        function updateTimeValueTable(scenario, elements) {
            const gender = elements.gender.value;
            const lifeExpectancy = LIFE_EXPECTANCY[gender];
            
            const yearsWorking = scenario.years;
            const yearsRetired = lifeExpectancy - scenario.age;
            const hoursWorking = yearsWorking * 40 * 52;
            const hoursRetired = yearsRetired * WAKING_HOURS_PER_YEAR;
            const daysWorking = hoursWorking / 16;
            const daysRetired = hoursRetired / 16;
            const birthdaysWorking = yearsWorking;
            const birthdaysRetired = yearsRetired;

            elements.timeValueTable.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="p-4 rounded-lg bg-gray-100 text-center">
                        <h4 class="font-bold text-lg text-gray-800 flex items-center justify-center"><i data-lucide="briefcase" class="w-5 h-5 mr-2"></i>The Working Years</h4>
                        <div class="mt-2 space-y-1">
                            <p><strong class="text-2xl text-red-600">${formatNumber(birthdaysWorking, 0)}</strong> Birthdays</p>
                            <p><strong class="text-lg text-red-600">${formatNumber(daysWorking, 0)}</strong> Waking Days</p>
                            <p><strong class="text-lg text-red-600">${formatNumber(hoursWorking, 0)}</strong> Waking Hours</p>
                        </div>
                    </div>
                    <div class="p-4 rounded-lg bg-indigo-50 text-center">
                        <h4 class="font-bold text-lg text-indigo-800 flex items-center justify-center"><i data-lucide="sunset" class="w-5 h-5 mr-2"></i>The Freedom Years</h4>
                         <div class="mt-2 space-y-1">
                            <p><strong class="text-2xl text-green-600">${formatNumber(birthdaysRetired, 0)}</strong> Birthdays</p>
                            <p><strong class="text-lg text-green-600">${formatNumber(daysRetired, 0)}</strong> Waking Days</p>
                            <p><strong class="text-lg text-green-600">${formatNumber(hoursRetired, 0)}</strong> Waking Hours</p>
                        </div>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        // --- Money Motive Quiz Logic ---
        const quizData = [
            { question: "When you get an unexpected bonus, your first thought is:", answers: [ { text: "Put it straight into savings or investments.", motive: "Security" }, { text: "Book a flight for a spontaneous trip.", motive: "Experience" }, { text: "Treat your friends or family to a nice dinner.", motive: "Generous" }, { text: "Buy that designer item you've been eyeing.", motive: "Status" } ] },
            { question: "You're most likely to spend money on:", answers: [ { text: "A course to learn a new skill.", motive: "Security" }, { text: "Tickets to a concert or festival.", motive: "Experience" }, { text: "A donation to a cause you care about.", motive: "Generous" }, { text: "Upgrading your car or phone.", motive: "Status" } ] },
            { question: "Your ideal weekend involves:", answers: [ { text: "Organizing your finances and planning for the future.", motive: "Security" }, { text: "Exploring a new city or hiking trail.", motive: "Experience" }, { text: "Volunteering or hosting a get-together.", motive: "Generous" }, { text: "Shopping at a high-end mall.", motive: "Status" } ] },
            { question: "When you think about money, you feel most successful when:", answers: [ { text: "Your emergency fund is fully stocked.", motive: "Security" }, { text: "You have a rich collection of memories and stories.", motive: "Experience" }, { text: "You can help someone in need without worrying.", motive: "Generous" }, { text: "People notice and admire your lifestyle.", motive: "Status" } ] },
            { question: "Which phrase resonates with you most?", answers: [ { text: "Slow and steady wins the race.", motive: "Security" }, { text: "Collect moments, not things.", motive: "Experience" }, { text: "It's better to give than to receive.", motive: "Generous" }, { text: "You get what you pay for.", motive: "Status" } ] },
            { question: "A 'rich life' to you means:", answers: [ { text: "Never having to worry about money.", motive: "Security" }, { text: "Freedom to travel and explore.", motive: "Experience" }, { text: "The ability to support your community.", motive: "Generous" }, { text: "Enjoying the best of everything.", motive: "Status" } ] }
        ];

        const archetypes = {
            Security: { title: "The Security Seeker", icon: '<i data-lucide="shield-check" class="w-16 h-16 text-green-500"></i>', description: "You are motivated by stability and peace of mind. You find comfort in planning, saving, and knowing you're prepared for the future.", strengths: "Excellent at saving, disciplined, and great at long-term planning.", blinds: "May be overly risk-averse, potentially missing out on growth opportunities. Can sometimes delay gratification to an extent that they forget to enjoy the present.", mantra: "My financial plan gives me the freedom to be secure today and enjoy tomorrow." },
            Experience: { title: "The Experience Chaser", icon: '<i data-lucide="map" class="w-16 h-16 text-yellow-500"></i>', description: "You believe life is about the memories you make, not the things you own. You prioritize spending on travel, events, and activities that enrich your life.", strengths: "Lives a rich and fulfilling life full of stories. Understands that value isn't always monetary.", blinds: "Can struggle with long-term savings goals. May prioritize a short-term adventure over a long-term need, like retirement savings.", mantra: "I can build a future that funds my adventures and secures my peace." },
            Generous: { title: "The Generous Giver", icon: '<i data-lucide="heart-handshake" class="w-16 h-16 text-pink-500"></i>', description: "You find the greatest joy in using your resources to help others. Your financial decisions are often guided by your heart.", strengths: "Deeply empathetic and builds strong community bonds. Finds immense fulfillment in helping others.", blinds: "May neglect their own financial needs, a classic 'put your own oxygen mask on first' scenario. Can sometimes be taken advantage of financially.", mantra: "Securing my own finances is the most powerful way I can continue to help others." },
            Status: { title: "The Status Symbolist", icon: '<i data-lucide="gem" class="w-16 h-16 text-purple-500"></i>', description: "You appreciate quality, craftsmanship, and the finer things in life. You see money as a tool to achieve a certain lifestyle.", strengths: "Often highly driven and successful. Has a clear vision for the life they want to build.", blinds: "Susceptible to lifestyle inflation. May tie self-worth too closely to material possessions, leading to a never-ending cycle of spending.", mantra: "I define my success; my possessions do not. True wealth is freedom." }
        };

        let currentQuestionIndex = 0;
        let motiveScores = {};

        function startQuiz(elements) {
            currentQuestionIndex = 0;
            motiveScores = { Security: 0, Experience: 0, Generous: 0, Status: 0 };
            elements.quizContainer.classList.remove('hidden');
            elements.motiveResultContainer.classList.add('hidden');
            displayQuestion(elements);
        }

        function displayQuestion(elements) {
            const questionData = quizData[currentQuestionIndex];
            elements.quizQuestion.textContent = questionData.question;
            elements.quizOptions.innerHTML = '';
            questionData.answers.forEach(answer => {
                const button = document.createElement('button');
                button.className = 'quiz-option p-4 border-2 border-gray-200 rounded-lg text-left hover:bg-indigo-50 hover:border-indigo-300';
                button.textContent = answer.text;
                button.onclick = () => selectAnswer(answer.motive, elements);
                elements.quizOptions.appendChild(button);
            });
            const progress = ((currentQuestionIndex) / quizData.length) * 100;
            elements.quizProgress.style.width = `${progress}%`;
        }

        function selectAnswer(motive, elements) {
            motiveScores[motive]++;
            currentQuestionIndex++;
            if (currentQuestionIndex < quizData.length) {
                displayQuestion(elements);
            } else {
                showResults(elements);
            }
        }

        function showResults(elements) {
            const finalMotive = Object.keys(motiveScores).reduce((a, b) => motiveScores[a] > motiveScores[b] ? a : b);
            userMotive = finalMotive;
            const archetype = archetypes[finalMotive];
            
            elements.archetypeIcon.innerHTML = archetype.icon;
            elements.archetypeTitle.textContent = archetype.title;
            elements.archetypeDescription.textContent = archetype.description;
            elements.archetypeStrengths.textContent = archetype.strengths;
            elements.archetypeBlinds.textContent = archetype.blinds;
            elements.archetypeMantra.textContent = `"${archetype.mantra}"`;
            
            elements.quizContainer.classList.add('hidden');
            elements.motiveResultContainer.classList.remove('hidden');
            lucide.createIcons();
        }

        // --- Dynamic Facts Logic ---
        function displayDynamicFact(tab, elements) {
            const age = parseInt(elements.age.value) || 30;
            const gender = elements.gender.value;
            const factContainer = document.getElementById(`${tab}-fact`);
            if (!factContainer) return;

            let facts = [];
            
            // Age-based facts
            if (age < 30) {
                facts.push("Did you know? Thanks to compound interest, a dollar saved in your 20s can be worth nearly 15 times as much as a dollar saved in your 50s.");
            } else if (age >= 50) {
                facts.push("Food for thought: The average healthcare cost for a retired couple is over $300,000. Planning for this now creates peace of mind for later.");
            }

            // Gender-based facts
            if (gender === 'female') {
                facts.push("On average, women live longer than men, meaning retirement savings need to last longer. Every dollar invested today is an investment in your future independence.");
            }

            // Motive-based facts
            if (userMotive === 'Security') {
                facts.push("A study found that people with a stocked emergency fund report significantly lower stress levels, regardless of their income.");
            } else if (userMotive === 'Experience') {
                facts.push("Research from Cornell University shows that the happiness from experiential purchases lasts far longer than the happiness from material ones.");
            } else if (userMotive === 'Generous') {
                facts.push("Strategic giving, like donating appreciated stocks, can often provide a larger tax benefit, allowing you to give even more to the causes you love.");
            } else if (userMotive === 'Status') {
                facts.push("The average new car loses about 20% of its value in the first year. Investing that difference could be worth tens of thousands in the future.");
            }

            // Default facts if no specific ones match
            if (facts.length === 0) {
                facts.push("The S&P 500 has historically returned an average of about 10% per year. Investing is one of the most powerful tools for building wealth.");
                facts.push("A 'latte factor' of $5 a day adds up to $1,825 a year. Invested, that could be over $100,000 in 30 years.");
            }

            const randomFact = facts[Math.floor(Math.random() * facts.length)];
            factContainer.innerHTML = `<p class="text-indigo-800"><i class="inline-block" data-lucide="lightbulb"></i> <strong>Food for Thought:</strong> ${randomFact}</p>`;
            factContainer.classList.remove('hidden');
            lucide.createIcons();
        }


        // --- Event Listeners and Initial Load ---
        function initializeApp() {
            // --- DOM Elements ---
            const elements = {
                // Main Inputs
                age: document.getElementById('age'),
                gender: document.getElementById('gender'),
                itemName: document.getElementById('itemName'),
                itemCost: document.getElementById('itemCost'),
                preTaxHourlyIncome: document.getElementById('preTaxHourlyIncome'),
                location: document.getElementById('location'),
                paycheckFrequency: document.getElementById('paycheckFrequency'),
                currentSavings: document.getElementById('currentSavings'),
                monthlyExpenses: document.getElementById('monthlyExpenses'),
                // Results Display
                resultsSection: document.getElementById('results-section'),
                resultItemName: document.getElementById('resultItemName'),
                totalCostWithTax: document.getElementById('totalCostWithTax'),
                netIncomeDisplay: document.getElementById('netIncomeDisplay'),
                hoursWorked: document.getElementById('hoursWorked'),
                daysWorked: document.getElementById('daysWorked'),
                hoursLeft: document.getElementById('hoursLeft'),
                lifePercentage: document.getElementById('lifePercentage'),
                paycheckPercentage: document.getElementById('paycheckPercentage'),
                freedomFundCard: document.getElementById('freedom-fund-card'),
                runwayMonths: document.getElementById('runwayMonths'),
                runwayAdded: document.getElementById('runwayAdded'),
                // Quiz
                quizContainer: document.getElementById('quiz-container'),
                motiveResultContainer: document.getElementById('motive-result-container'),
                quizQuestion: document.getElementById('quizQuestion'),
                quizOptions: document.getElementById('quizOptions'),
                quizProgress: document.getElementById('quiz-progress'),
                archetypeIcon: document.getElementById('archetypeIcon'),
                archetypeTitle: document.getElementById('archetypeTitle'),
                archetypeDescription: document.getElementById('archetypeDescription'),
                archetypeStrengths: document.getElementById('archetypeStrengths'),
                archetypeBlinds: document.getElementById('archetypeBlinds'),
                archetypeMantra: document.getElementById('archetypeMantra'),
                // Goals
                goalName: document.getElementById('goalName'),
                goalAmount: document.getElementById('goalAmount'),
                currentGoalSavings: document.getElementById('currentGoalSavings'),
                goalTrackerSection: document.getElementById('goal-tracker-section'),
                goalResultName: document.getElementById('goalResultName'),
                goalItemName: document.getElementById('goalItemName'),
                goalContribution: document.getElementById('goalContribution'),
                // Retirement
                retireAge: document.getElementById('retireAge'),
                annualIncome: document.getElementById('annualIncome'),
                currentRetireSavings: document.getElementById('currentRetireSavings'),
                savingsRate: document.getElementById('savingsRate'),
                annualExpenses: document.getElementById('annualExpenses'),
                retirementDream: document.getElementById('retirementDream'),
                retirementResultsSection: document.getElementById('retirement-results-section'),
                dreamDisplay: document.getElementById('dreamDisplay'),
                retirementAgeResult: document.getElementById('retirementAgeResult'),
                fiNumberResult: document.getElementById('fiNumberResult'),
                withdrawalResult: document.getElementById('withdrawalResult'),
                retireItemName: document.getElementById('retireItemName'),
                purchaseImpactResult: document.getElementById('purchaseImpactResult'),
                retirementMeaning: document.getElementById('retirementMeaning'),
                timeValueTable: document.getElementById('timeValueTable')
            };

            // --- Event Listeners ---
            document.getElementById('calculateBtn').addEventListener('click', () => calculatePurchase(elements));
            document.getElementById('setGoalBtn').addEventListener('click', () => setGoal(elements));
            document.getElementById('calculateRetireBtn').addEventListener('click', () => handleRetirementCalculation(elements));
            document.getElementById('retakeQuizBtn').addEventListener('click', () => startQuiz(elements));
            
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    switchTab(button.dataset.tab);
                });
            });

            lucide.createIcons();
            startQuiz(elements); 
        }
    </script>
</body>
</html>
